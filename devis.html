<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Demander un Devis | Plomberie St-Mars</title>
    
    <!-- Framework & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --primary: #0055ff;
            --secondary: #0F172A;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 85, 255, 0.1);
        }

        .step-pill.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 85, 255, 0.3);
        }

        .hero-gradient {
            background: radial-gradient(circle at top right, #e0f2fe, transparent),
                        radial-gradient(circle at bottom left, #f0f9ff, transparent);
        }

        input, select, textarea {
            font-size: 16px !important;
        }

        .sms-notification {
            position: fixed;
            top: -150px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 380px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            display: flex;
            gap: 14px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .sms-icon {
            width: 44px;
            height: 44px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="min-h-screen hero-gradient">

    <!-- Notification SMS simulée -->
    <div id="sms-pop" class="sms-notification" onclick="gsap.to('#sms-pop', {top: -150})">
        <div class="sms-icon"><i class="fas fa-file-invoice-dollar text-lg"></i></div>
        <div class="flex-1">
            <div class="flex justify-between items-center mb-1">
                <span class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Messages</span>
                <span class="text-[10px] text-slate-400">À l'instant</span>
            </div>
            <p class="text-xs font-bold text-slate-900">Plomberie St-Mars</p>
            <p id="sms-text" class="text-[11px] text-slate-600 leading-tight mt-0.5"></p>
        </div>
    </div>

    <nav class="p-4 md:p-6">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white transition group-hover:rotate-12 shadow-lg shadow-blue-200">
                    <i class="fas fa-arrow-left text-sm"></i>
                </div>
                <span class="font-bold text-slate-800 hidden sm:inline">Retour</span>
            </a>
            <div class="text-xl md:text-2xl font-black text-slate-900 tracking-tight">ST-MARS</div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 md:px-6 py-6 md:py-12">
        <div class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-3">Obtenez votre devis gratuit</h1>
            <p class="text-slate-600 text-sm md:text-base">Décrivez votre besoin en 2 minutes, nous vous répondrons avec une estimation précise.</p>
        </div>

        <div class="flex justify-start md:justify-center gap-3 mb-8 overflow-x-auto pb-2">
            <div id="step-1-pill" class="step-pill active px-5 py-2.5 rounded-full text-xs md:text-sm font-bold whitespace-nowrap transition-all">1. Votre demande</div>
            <div id="step-2-pill" class="step-pill bg-white text-slate-400 px-5 py-2.5 rounded-full text-xs md:text-sm font-bold whitespace-nowrap transition-all">2. Terminé</div>
        </div>

        <div class="glass-card rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-12 shadow-2xl relative">
            
            <!-- ÉTAPE 1 : Informations du Devis -->
            <div id="step-1" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-5">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Nom Complet *</label>
                        <input type="text" id="fullname" placeholder="Jean Tremblay" class="w-full p-4 rounded-2xl border border-slate-200 outline-none transition bg-white/50 focus:border-blue-500" required>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Téléphone (514/438) *</label>
                        <input type="tel" id="phone" placeholder="(514) 000-0000" class="w-full p-4 rounded-2xl border border-slate-200 outline-none transition bg-white/50 focus:border-blue-500" required>
                        <p id="phone-error" class="text-[10px] text-red-500 font-bold hidden">Préfixe 514 ou 438 requis.</p>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-5">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Courriel *</label>
                        <input type="email" id="email" placeholder="jean@exemple.com" class="w-full p-4 rounded-2xl border border-slate-200 outline-none transition bg-white/50 focus:border-blue-500" required>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Type de service</label>
                        <select id="service-type" class="w-full p-4 rounded-2xl border border-slate-200 outline-none bg-white">
                            <option value="Rénovation salle de bain">Rénovation de salle de bain</option>
                            <option value="Installation chauffe-eau">Installation chauffe-eau</option>
                            <option value="Remplacement tuyauterie">Remplacement de tuyauterie</option>
                            <option value="Projet commercial">Projet commercial</option>
                            <option value="Autre">Autre projet</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Description détaillée du projet *</label>
                    <textarea id="description" rows="4" placeholder="Veuillez décrire votre projet, l'emplacement, et tout autre détail pertinent pour nous aider à évaluer les coûts..." class="w-full p-4 rounded-2xl border border-slate-200 outline-none transition bg-white/50 focus:border-blue-500" required></textarea>
                </div>

                <button id="btn-submit" onclick="submitQuote()" class="w-full bg-blue-600 text-white p-5 rounded-2xl font-bold text-lg shadow-xl hover:bg-blue-700 transition-all">
                    Envoyer ma demande de devis <i class="fas fa-paper-plane ml-2"></i>
                </button>
            </div>

            <!-- ÉTAPE 2 : Succès -->
            <div id="step-2" class="hidden text-center py-10 space-y-6">
                <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 animate-bounce">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="text-2xl font-extrabold text-slate-900">Demande envoyée !</h2>
                <p class="text-slate-600 max-w-sm mx-auto text-sm">
                    Merci <span id="summary-name" class="font-bold"></span>. Votre demande de devis a bien été enregistrée. Nous vous répondrons dans les plus brefs délais au <span id="summary-email" class="font-bold text-blue-600"></span>.
                </p>
                <div class="pt-6">
                    <a href="index.html" class="inline-block bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold hover:bg-blue-600 transition">Retour à l'accueil</a>
                </div>
            </div>

        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'plomberie-app';

        let user = null;

        // Authentification
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) { console.error("Auth error", e); }
        };
        initAuth();
        onAuthStateChanged(auth, (u) => { user = u; });

        // Formattage téléphone et validation 514/438
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            let x = val.match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            
            const errorMsg = document.getElementById('phone-error');
            if (val.length >= 3) {
                const prefix = val.substring(0, 3);
                if (prefix !== "514" && prefix !== "438") {
                    errorMsg.classList.remove('hidden');
                } else {
                    errorMsg.classList.add('hidden');
                }
            } else {
                errorMsg.classList.add('hidden');
            }
        });

        window.submitQuote = async function() {
            // Récupération des valeurs
            const name = document.getElementById('fullname').value.trim();
            const rawPhone = document.getElementById('phone').value.replace(/\D/g, '');
            const phoneDisplay = document.getElementById('phone').value;
            const email = document.getElementById('email').value.trim();
            const service = document.getElementById('service-type').value;
            const description = document.getElementById('description').value.trim();

            // Validation des champs
            if (!name || !rawPhone || !email || !description) {
                alert("Veuillez remplir tous les champs obligatoires (*).");
                return;
            }

            // Validation du préfixe 514 / 438
            const prefix = rawPhone.substring(0, 3);
            if (prefix !== "514" && prefix !== "438") {
                alert("Désolé, nous ne desservons que les secteurs 514 et 438.");
                return;
            }

            if (!user) {
                alert("Erreur de session. Veuillez rafraîchir la page.");
                return;
            }

            const btn = document.getElementById('btn-submit');
            btn.innerHTML = "Envoi en cours... <i class='fas fa-spinner fa-spin ml-2'></i>";
            btn.disabled = true;
            btn.classList.add('opacity-75');

            const quoteData = {
                type: "Demande de Devis",
                clientName: name,
                phone: phoneDisplay,
                email: email,
                service: service,
                description: description,
                createdAt: serverTimestamp(),
                userId: user.uid
            };

            try {
                // SAUVEGARDE DANS FIRESTORE
                const quotesRef = collection(db, 'artifacts', appId, 'public', 'data', 'quotes');
                await addDoc(quotesRef, quoteData);

                // Mise à jour de l'UI
                document.getElementById('summary-name').innerText = name;
                document.getElementById('summary-email').innerText = email;
                
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.remove('hidden');
                
                document.getElementById('step-1-pill').classList.remove('active', 'bg-blue-600', 'text-white');
                document.getElementById('step-1-pill').classList.add('bg-white', 'text-slate-400');
                document.getElementById('step-2-pill').classList.remove('bg-white', 'text-slate-400');
                document.getElementById('step-2-pill').classList.add('active');

                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Animation SMS
                const sms = document.getElementById('sms-pop');
                document.getElementById('sms-text').innerText = `Bonjour ${name.split(' ')[0]}, votre demande de devis a été enregistrée dans notre système cloud !`;
                gsap.to(sms, { top: 16, duration: 0.8 });
                setTimeout(() => gsap.to(sms, { top: -150, duration: 0.8 }), 6000);

            } catch (error) {
                console.error("Firestore Error:", error);
                alert("Désolé, une erreur est survenue lors de l'envoi vers la base de données.");
                btn.innerHTML = "Envoyer ma demande de devis <i class='fas fa-paper-plane ml-2'></i>";
                btn.disabled = false;
                btn.classList.remove('opacity-75');
            }
        };
    </script>
</body>
</html>
