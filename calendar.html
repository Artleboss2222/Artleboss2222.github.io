<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réserver une visite — Plomberie St-Mars</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --bg:   #050505;
            --text: #ffffff;
            --blue: #0055ff;
            --gold: #FFD700;
            --s1:   #111111;
            --s2:   #181818;
            --s3:   #1f1f1f;
            --brd:  rgba(255,255,255,0.08);
            --ease: cubic-bezier(0.23,1,0.32,1);
        }
        *{margin:0;padding:0;box-sizing:border-box;outline:none}
        html{background:var(--bg);scroll-behavior:smooth}
        body{font-family:'Inter',sans-serif;color:var(--text);line-height:1.6;min-height:100vh;overflow-x:hidden}
        h1,h2,h3,h4,.logo{font-family:'Syne',sans-serif;text-transform:uppercase}

        /* ── NAV ── */
        .nav{position:fixed;top:0;width:100%;z-index:100;padding:1.1rem 0;background:rgba(5,5,5,.85);backdrop-filter:blur(16px);border-bottom:1px solid var(--brd)}
        .nav-c{max-width:1300px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 40px}
        .logo{font-size:1.4rem;font-weight:800;letter-spacing:-1px;text-decoration:none;color:var(--text)}
        .nav-back{display:flex;align-items:center;gap:6px;text-decoration:none;color:rgba(255,255,255,.45);font-size:.85rem;font-weight:600;transition:color .3s}
        .nav-back:hover{color:var(--text)}
        .nav-phone{background:var(--blue);color:#fff;padding:.65rem 1.2rem;border-radius:4px;text-decoration:none;font-weight:600;font-size:.82rem}

        /* ── PAGE ── */
        .page{min-height:100vh;padding:100px 24px 80px;display:flex;justify-content:center}
        .wrap{width:100%;max-width:1100px}

        /* ── HEADER ── */
        .ph{margin-bottom:48px;opacity:0;transform:translateY(28px)}
        .tag{display:inline-flex;align-items:center;gap:8px;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:2px;color:var(--blue);margin-bottom:14px}
        .tag::before{content:'';display:block;width:22px;height:1px;background:var(--blue)}
        .ph h1{font-size:clamp(1.8rem,4vw,3rem);line-height:1;margin-bottom:10px}
        .ph h1 span{color:var(--blue)}
        .ph p{color:rgba(255,255,255,.45);font-size:.95rem}

        /* ── GRID ── */
        .layout{display:grid;grid-template-columns:1fr 380px;gap:24px;opacity:0;transform:translateY(24px)}

        /* ── CALENDAR PANEL ── */
        .cal-panel{background:var(--s1);border:1px solid var(--brd);border-radius:18px;padding:32px}

        .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
        .cal-header h2{font-size:1.1rem;font-weight:700}
        .nav-month{background:var(--s2);border:1px solid var(--brd);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:rgba(255,255,255,.5);font-size:.85rem;transition:all .3s}
        .nav-month:hover{color:var(--text);border-color:rgba(255,255,255,.2)}

        .cal-days-header{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:8px}
        .cal-days-header span{text-align:center;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.3);padding:6px 0}

        .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}

        .cal-day{
            aspect-ratio:1;border-radius:10px;display:flex;align-items:center;justify-content:center;
            font-size:.88rem;font-weight:600;cursor:pointer;transition:all .25s;
            border:1px solid transparent;position:relative;
        }
        .cal-day:hover:not(.disabled):not(.empty){border-color:rgba(0,85,255,.4);background:rgba(0,85,255,.08);color:var(--blue)}
        .cal-day.today{border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.9)}
        .cal-day.selected{background:var(--blue);border-color:var(--blue);color:#fff}
        .cal-day.disabled{color:rgba(255,255,255,.15);cursor:not-allowed;background:transparent}
        .cal-day.closed{color:rgba(255,255,255,.12);cursor:not-allowed}
        .cal-day.closed::after{content:'fermé';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:.45rem;text-transform:uppercase;letter-spacing:.5px;color:rgba(255,255,255,.15)}
        .cal-day.empty{cursor:default}
        .cal-day.has-slots::before{content:'';position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--blue);opacity:.6}
        .cal-day.full::before{content:'';position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:#f84;opacity:.6}

        /* Légende */
        .cal-legend{display:flex;align-items:center;gap:18px;margin-top:20px;flex-wrap:wrap}
        .leg{display:flex;align-items:center;gap:6px;font-size:.72rem;color:rgba(255,255,255,.35)}
        .leg-dot{width:8px;height:8px;border-radius:50%}

        /* ── SLOTS PANEL ── */
        .slots-panel{background:var(--s1);border:1px solid var(--brd);border-radius:18px;padding:32px;display:flex;flex-direction:column}

        .sp-title{font-size:1rem;font-weight:700;margin-bottom:4px}
        .sp-date{font-size:.82rem;color:rgba(255,255,255,.4);margin-bottom:24px;min-height:20px}

        .sp-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:rgba(255,255,255,.2);text-align:center;gap:12px;padding:40px 0}
        .sp-empty i{font-size:2rem}
        .sp-empty p{font-size:.85rem}

        .slots-list{display:flex;flex-direction:column;gap:10px;margin-bottom:24px}
        .slot-btn{
            padding:14px 18px;border-radius:10px;border:1px solid var(--brd);background:var(--s2);
            display:flex;align-items:center;justify-content:space-between;
            cursor:pointer;transition:all .25s;
        }
        .slot-btn:hover:not(.booked):not(.gcal-busy){border-color:rgba(0,85,255,.4);background:rgba(0,85,255,.06)}
        .slot-btn.selected{border-color:var(--blue);background:rgba(0,85,255,.12)}
        .slot-btn.booked{opacity:.4;cursor:not-allowed}
        .slot-btn.gcal-busy{opacity:.35;cursor:not-allowed}
        .slot-time{font-size:.9rem;font-weight:600;color:rgba(255,255,255,.85)}
        .slot-tag{font-size:.7rem;font-weight:600;padding:3px 8px;border-radius:20px}
        .slot-tag.free{color:rgba(100,200,100,.8);background:rgba(80,180,80,.1);border:1px solid rgba(80,180,80,.2)}
        .slot-tag.taken{color:rgba(255,120,80,.8);background:rgba(255,100,60,.1);border:1px solid rgba(255,100,60,.2)}
        .slot-tag.busy{color:rgba(255,200,80,.7);background:rgba(255,180,40,.08);border:1px solid rgba(255,180,40,.15)}

        /* FORM DANS LE PANEL */
        .booking-form{margin-top:auto}
        .bf-divider{height:1px;background:var(--brd);margin:20px 0}

        .bf-fields{display:flex;flex-direction:column;gap:12px;margin-bottom:16px}
        .bf-field{display:flex;flex-direction:column;gap:6px}
        .bf-field label{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.4)}
        .bf-field input{background:var(--s2);border:1px solid var(--brd);border-radius:8px;padding:12px 14px;color:var(--text);font-family:'Inter',sans-serif;font-size:.88rem;transition:border-color .3s}
        .bf-field input:focus{border-color:var(--blue)}
        .bf-field input::placeholder{color:rgba(255,255,255,.2)}

        .btn-reserve{
            width:100%;padding:14px;border-radius:10px;border:none;
            background:var(--blue);color:#fff;
            font-family:'Inter',sans-serif;font-size:.9rem;font-weight:700;
            cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
            transition:all .3s;letter-spacing:.5px;
        }
        .btn-reserve:hover:not(:disabled){background:#0044dd;box-shadow:0 0 28px rgba(0,85,255,.35);transform:translateY(-1px)}
        .btn-reserve:disabled{opacity:.4;cursor:not-allowed;transform:none}

        /* ERREUR */
        .err{background:rgba(255,68,68,.1);border:1px solid rgba(255,68,68,.25);color:#f88;border-radius:8px;padding:12px 14px;font-size:.82rem;margin-top:10px;display:none;align-items:center;gap:8px}
        .err.show{display:flex}

        /* SUCCESS OVERLAY */
        .succ-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;padding:24px}
        .succ-overlay.show{display:flex}
        .succ-box{background:var(--s1);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:48px;max-width:480px;width:100%;text-align:center}
        .succ-icon{width:72px;height:72px;border-radius:50%;background:rgba(0,85,255,.12);border:1px solid rgba(0,85,255,.25);display:flex;align-items:center;justify-content:center;font-size:1.8rem;color:var(--blue);margin:0 auto 24px}
        .succ-box h2{font-size:1.8rem;margin-bottom:10px}
        .succ-box h2 span{color:var(--blue)}
        .succ-box p{color:rgba(255,255,255,.45);font-size:.9rem;margin-bottom:8px}
        .succ-ref{display:inline-block;font-family:'Syne',sans-serif;font-size:.7rem;letter-spacing:2px;color:rgba(255,255,255,.3);background:var(--s2);border:1px solid var(--brd);border-radius:6px;padding:5px 12px;margin:12px 0 28px}
        .succ-acts{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
        .btn-call{background:var(--blue);color:#fff;padding:.8rem 1.6rem;border-radius:8px;text-decoration:none;font-weight:700;font-size:.88rem;display:inline-flex;align-items:center;gap:8px;transition:all .3s}
        .btn-call:hover{background:#0044dd}
        .btn-home{border:1px solid var(--brd);color:rgba(255,255,255,.45);padding:.8rem 1.6rem;border-radius:8px;text-decoration:none;font-weight:600;font-size:.88rem;display:inline-flex;align-items:center;gap:8px;transition:all .3s}
        .btn-home:hover{border-color:rgba(255,255,255,.2);color:var(--text)}

        /* GCAL STATUS */
        .gcal-status{display:flex;align-items:center;gap:8px;font-size:.72rem;color:rgba(255,255,255,.3);margin-bottom:16px}
        .gcal-dot{width:6px;height:6px;border-radius:50%;background:#4f4}
        .gcal-dot.off{background:#f84}

        @media(max-width:900px){
            .layout{grid-template-columns:1fr}
            .nav-c{padding:0 20px}
        }
        @media(max-width:480px){
            .cal-panel,.slots-panel{padding:20px}
            .cal-day{font-size:.78rem}
        }
    </style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
    <div class="nav-c">
        <a href="index.html" class="logo">ST-MARS</a>
        <a href="index.html" class="nav-back"><i class="fa-solid fa-arrow-left"></i> Retour</a>
        <a href="tel:5149338411" class="nav-phone"><i class="fa-solid fa-phone"></i> (514) 933-8411</a>
    </div>
</nav>

<div class="page">
<div class="wrap">

    <!-- HEADER -->
    <div class="ph">
        <div class="tag">Prise de rendez-vous</div>
        <h1>Réservez votre <span>visite</span></h1>
        <p>Choisissez une date et un créneau — confirmation immédiate par courriel.</p>
    </div>

    <div class="layout" id="layout">

        <!-- CALENDRIER -->
        <div class="cal-panel">
            <div class="cal-header">
                <button class="nav-month" id="prev-month"><i class="fa-solid fa-chevron-left"></i></button>
                <h2 id="month-label">Février 2026</h2>
                <button class="nav-month" id="next-month"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <div class="cal-days-header">
                <span>Dim</span><span>Lun</span><span>Mar</span>
                <span>Mer</span><span>Jeu</span><span>Ven</span><span>Sam</span>
            </div>

            <div class="cal-grid" id="cal-grid"></div>

            <div class="cal-legend">
                <div class="leg"><div class="leg-dot" style="background:var(--blue)"></div> Disponible</div>
                <div class="leg"><div class="leg-dot" style="background:#f84"></div> Complet</div>
                <div class="leg"><div class="leg-dot" style="background:rgba(255,255,255,.15)"></div> Fermé</div>
            </div>
        </div>

        <!-- SLOTS + FORMULAIRE -->
        <div class="slots-panel">
            <div class="gcal-status">
                <div class="gcal-dot" id="gcal-dot"></div>
                <span id="gcal-lbl">Chargement du calendrier...</span>
            </div>

            <div class="sp-title">Créneaux disponibles</div>
            <div class="sp-date" id="sp-date"></div>

            <!-- État vide (aucune date sélectionnée) -->
            <div class="sp-empty" id="sp-empty">
                <i class="fa-regular fa-calendar"></i>
                <p>Sélectionnez une date<br>pour voir les créneaux</p>
            </div>

            <!-- Liste des slots (cachée au départ) -->
            <div class="slots-list" id="slots-list" style="display:none"></div>

            <!-- Formulaire de réservation -->
            <div class="booking-form" id="booking-form" style="display:none">
                <div class="bf-divider"></div>
                <div class="bf-fields">
                    <div class="bf-field">
                        <label>Prénom & Nom *</label>
                        <input type="text" id="bf-nom" placeholder="Jean Tremblay">
                    </div>
                    <div class="bf-field">
                        <label>Téléphone *</label>
                        <input type="tel" id="bf-tel" placeholder="(514) 000-0000">
                    </div>
                    <div class="bf-field">
                        <label>Courriel *</label>
                        <input type="email" id="bf-email" placeholder="jean@exemple.com">
                    </div>
                    <div class="bf-field">
                        <label>Type de problème</label>
                        <input type="text" id="bf-type" placeholder="Fuite, gaz, rénovation...">
                    </div>
                </div>
                <div class="err" id="err"><i class="fa-solid fa-circle-exclamation"></i><span id="err-msg">Erreur</span></div>
                <button class="btn-reserve" id="btn-reserve" onclick="submitReservation()" disabled>
                    <i class="fa-solid fa-calendar-check"></i> Confirmer la réservation
                </button>
            </div>
        </div>

    </div><!-- /layout -->
</div>
</div>

<!-- SUCCESS OVERLAY -->
<div class="succ-overlay" id="succ-overlay">
    <div class="succ-box">
        <div class="succ-icon"><i class="fa-solid fa-check"></i></div>
        <h2>Rendez-vous <span>confirmé</span> !</h2>
        <p id="succ-summary">Votre rendez-vous a été enregistré.</p>
        <p style="font-size:.8rem;color:rgba(255,255,255,.3)">Un courriel de confirmation vous a été envoyé.</p>
        <div class="succ-ref" id="succ-ref">Référence : —</div>
        <div class="succ-acts">
            <a href="tel:5149338411" class="btn-call"><i class="fa-solid fa-phone"></i> (514) 933-8411</a>
            <a href="index.html" class="btn-home"><i class="fa-solid fa-house"></i> Retour au site</a>
        </div>
    </div>
</div>

<!-- ══════════════════════════════════════════
     FIREBASE REALTIME DATABASE
══════════════════════════════════════════ -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const cfg = {
        apiKey:            "AIzaSyAOvVeABSSBiZ-MKKsYUphIh0YqTa5cED8",
        authDomain:        "plomberie-saint-mars.firebaseapp.com",
        databaseURL:       "https://plomberie-saint-mars-default-rtdb.firebaseio.com",
        projectId:         "plomberie-saint-mars",
        storageBucket:     "plomberie-saint-mars.firebasestorage.app",
        messagingSenderId: "858495795021",
        appId:             "1:858495795021:web:e3c1c6387e07d30ab34104",
        measurementId:     "G-MR8W8BBLLK"
    };

    const app = initializeApp(cfg);
    const db  = getDatabase(app);

    // Écoute temps réel des réservations confirmées
    onValue(ref(db, 'reservations'), snap => {
        window._reservations = snap.val() || {};
        refreshSlots();
    });

    // Sauvegarder une réservation
    window._fbSaveReservation = async (data) => {
        const r = await push(ref(db, 'reservations'), data);
        return r.key;
    };
</script>

<!-- ══════════════════════════════════════════
     GOOGLE CALENDAR API
     → Remplacez les 2 valeurs ci-dessous
       quand vous avez votre clé API Google
══════════════════════════════════════════ -->
<script>
    // ⚙️ CONFIGUREZ CES 2 VALEURS :
const GCAL_API_KEY      = "AIzaSyC7dmd5hD0pMiehpdf8EoKCQHhTcB02jPc";
const GCAL_CALENDAR_ID  = "wikifn.com@gmail.com";

// On change la condition pour vérifier que ce n'est plus la valeur par défaut
const GCAL_ENABLED = GCAL_API_KEY !== "" && GCAL_API_KEY !== "VOTRE_GOOGLE_API_KEY";

window._gcalBusy = [];

    async function loadGoogleCalendar(monthStart, monthEnd) {
        if (!GCAL_ENABLED) {
            document.getElementById('gcal-dot').classList.add('off');
            document.getElementById('gcal-lbl').textContent = 'Google Calendar non configuré';
            return;
        }
        try {
            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(GCAL_CALENDAR_ID)}/events`
                + `?key=${GCAL_API_KEY}`
                + `&timeMin=${monthStart.toISOString()}`
                + `&timeMax=${monthEnd.toISOString()}`
                + `&singleEvents=true&orderBy=startTime`;
            const res  = await fetch(url);
            const data = await res.json();
            window._gcalBusy = (data.items || []).map(e => ({
                start: e.start.dateTime || e.start.date,
                end:   e.end.dateTime   || e.end.date
            }));
            document.getElementById('gcal-dot').classList.remove('off');
            document.getElementById('gcal-lbl').textContent = 'Synchronisé avec Google Calendar';
            refreshSlots();
        } catch(e) {
            document.getElementById('gcal-dot').classList.add('off');
            document.getElementById('gcal-lbl').textContent = 'Google Calendar indisponible';
        }
    }
</script>

<!-- ══════════════════════════════════════════
     EMAILJS (emails de confirmation)
     → Créez un compte sur emailjs.com
       puis remplacez les 3 valeurs ci-dessous
══════════════════════════════════════════ -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
    // ⚙️ CONFIGUREZ CES 3 VALEURS sur emailjs.com :
    const EJS_PUBLIC_KEY  = "VOTRE_EMAILJS_PUBLIC_KEY";
    const EJS_SERVICE_ID  = "VOTRE_EMAILJS_SERVICE_ID";
    const EJS_TEMPLATE_ID = "VOTRE_EMAILJS_TEMPLATE_ID";

    const EJS_ENABLED = EJS_PUBLIC_KEY !== "VOTRE_EMAILJS_PUBLIC_KEY";
    if (EJS_ENABLED) emailjs.init(EJS_PUBLIC_KEY);

    async function sendConfirmationEmail(data) {
        if (!EJS_ENABLED) { console.log("EmailJS non configuré — email non envoyé"); return; }
        await emailjs.send(EJS_SERVICE_ID, EJS_TEMPLATE_ID, {
            client_nom:    data.nom,
            client_email:  data.email,
            client_tel:    data.telephone,
            rdv_date:      data.dateLabel,
            rdv_heure:     data.slot,
            rdv_type:      data.typeProbleme,
            ref_id:        data.refId
        });
    }
</script>

<!-- ══════════════════════════════════════════
     LOGIQUE PRINCIPALE
══════════════════════════════════════════ -->
<script>
    // ── Horaires d'ouverture (0=dim,1=lun,...,6=sam)
    // Format : { open: "HH:MM", close: "HH:MM" } ou null si fermé
    const SCHEDULE = {
        0: null,                        // Dimanche — fermé
        1: { open:"08:00", close:"17:00" }, // Lundi
        2: { open:"08:00", close:"17:00" }, // Mardi
        3: { open:"08:00", close:"17:00" }, // Mercredi
        4: { open:"08:00", close:"17:00" }, // Jeudi
        5: { open:"08:00", close:"16:00" }, // Vendredi (ferme à 16h)
        6: null                         // Samedi — fermé
    };

    // Durée d'un créneau en minutes
    const SLOT_DURATION = 120; // 2h par créneau

    // ── État
    let today       = new Date();
    today.setHours(0,0,0,0);
    let viewYear    = today.getFullYear();
    let viewMonth   = today.getMonth();
    let selectedDay = null; // objet Date
    let selectedSlot= null; // string "HH:MM–HH:MM"

    window._reservations = {};
    window._gcalBusy     = [];

    // ── Animations d'entrée
    window.addEventListener('load', () => {
        gsap.to('.ph',      { opacity:1, y:0, duration:.9, ease:'power3.out', delay:.1 });
        gsap.to('#layout',  { opacity:1, y:0, duration:.8, ease:'power3.out', delay:.3 });
        renderCalendar();
        loadGoogleCalendar(
            new Date(viewYear, viewMonth, 1),
            new Date(viewYear, viewMonth+1, 1)
        );
    });

    // ── Navigation mois
    document.getElementById('prev-month').onclick = () => {
        viewMonth--;
        if (viewMonth < 0) { viewMonth = 11; viewYear--; }
        selectedDay = null;
        renderCalendar();
        loadGoogleCalendar(
            new Date(viewYear, viewMonth, 1),
            new Date(viewYear, viewMonth+1, 1)
        );
        resetSlots();
    };
    document.getElementById('next-month').onclick = () => {
        viewMonth++;
        if (viewMonth > 11) { viewMonth = 0; viewYear++; }
        selectedDay = null;
        renderCalendar();
        loadGoogleCalendar(
            new Date(viewYear, viewMonth, 1),
            new Date(viewYear, viewMonth+1, 1)
        );
        resetSlots();
    };

    // ── Générer les créneaux d'une journée
    function generateSlots(date) {
        const dow = date.getDay();
        const sch = SCHEDULE[dow];
        if (!sch) return []; // fermé

        const slots = [];
        const [oh, om] = sch.open.split(':').map(Number);
        const [ch, cm] = sch.close.split(':').map(Number);
        let cur = oh * 60 + om;
        const end = ch * 60 + cm;

        while (cur + SLOT_DURATION <= end) {
            const sh = String(Math.floor(cur/60)).padStart(2,'0');
            const sm = String(cur%60).padStart(2,'0');
            const eh = String(Math.floor((cur+SLOT_DURATION)/60)).padStart(2,'0');
            const em = String((cur+SLOT_DURATION)%60).padStart(2,'0');
            slots.push(`${sh}:${sm}–${eh}:${em}`);
            cur += SLOT_DURATION;
        }
        return slots;
    }

    // ── Vérifier si un créneau est pris dans Firebase
    function isBookedFirebase(dateStr, slot) {
        return Object.values(window._reservations).some(r =>
            r.dateStr === dateStr && r.slot === slot
        );
    }

    // ── Vérifier si un créneau chevauche un événement Google Calendar
    function isGcalBusy(date, slot) {
        const [startT, endT] = slot.split('–');
        const [sh, sm] = startT.split(':').map(Number);
        const [eh, em] = endT.split(':').map(Number);
        const slotStart = new Date(date); slotStart.setHours(sh, sm, 0, 0);
        const slotEnd   = new Date(date); slotEnd.setHours(eh, em, 0, 0);

        return window._gcalBusy.some(ev => {
            const evStart = new Date(ev.start);
            const evEnd   = new Date(ev.end);
            return slotStart < evEnd && slotEnd > evStart;
        });
    }

    // ── Vérifier si un jour a au moins un créneau libre
    function dayHasFreeSlot(date) {
        const dateStr = toDateStr(date);
        const slots   = generateSlots(date);
        return slots.some(s => !isBookedFirebase(dateStr, s) && !isGcalBusy(date, s));
    }

    function dayIsFull(date) {
        const dateStr = toDateStr(date);
        const slots   = generateSlots(date);
        if (!slots.length) return false;
        return slots.every(s => isBookedFirebase(dateStr, s) || isGcalBusy(date, s));
    }

    function toDateStr(date) {
        return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    }

    // ── Rendu du calendrier
    function renderCalendar() {
        const months_fr = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
        document.getElementById('month-label').textContent = `${months_fr[viewMonth]} ${viewYear}`;

        const grid   = document.getElementById('cal-grid');
        grid.innerHTML = '';

        const firstDay = new Date(viewYear, viewMonth, 1).getDay();
        const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();

        // Cases vides avant le 1er
        for (let i=0; i<firstDay; i++) {
            const el = document.createElement('div');
            el.className = 'cal-day empty';
            grid.appendChild(el);
        }

        for (let d=1; d<=daysInMonth; d++) {
            const date = new Date(viewYear, viewMonth, d);
            const dow  = date.getDay();
            const el   = document.createElement('div');
            el.className = 'cal-day';
            el.textContent = d;

            const isPast   = date < today;
            const isClosed = SCHEDULE[dow] === null;
            const isToday  = date.getTime() === today.getTime();
            const isSel    = selectedDay && date.getTime() === selectedDay.getTime();

            if (isToday) el.classList.add('today');
            if (isSel)   el.classList.add('selected');

            if (isPast) {
                el.classList.add('disabled');
            } else if (isClosed) {
                el.classList.add('closed');
            } else {
                const slots = generateSlots(date);
                if (dayIsFull(date)) {
                    el.classList.add('full');
                } else if (slots.length > 0) {
                    el.classList.add('has-slots');
                }
                el.addEventListener('click', () => selectDay(date));
            }

            grid.appendChild(el);
        }
    }

    // ── Sélection d'un jour
    function selectDay(date) {
        selectedDay  = date;
        selectedSlot = null;
        renderCalendar();
        refreshSlots();
        document.getElementById('btn-reserve').disabled = true;
    }

    // ── Afficher les créneaux du jour sélectionné
    function refreshSlots() {
        if (!selectedDay) return;

        const days_fr  = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
        const months_fr = ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];
        const label = `${days_fr[selectedDay.getDay()]} ${selectedDay.getDate()} ${months_fr[selectedDay.getMonth()]} ${selectedDay.getFullYear()}`;
        document.getElementById('sp-date').textContent = label;

        const dateStr = toDateStr(selectedDay);
        const slots   = generateSlots(selectedDay);
        const list    = document.getElementById('slots-list');
        list.innerHTML = '';

        document.getElementById('sp-empty').style.display  = 'none';
        document.getElementById('slots-list').style.display = 'flex';
        document.getElementById('booking-form').style.display = 'block';

        if (!slots.length) {
            list.innerHTML = '<div style="color:rgba(255,255,255,.25);font-size:.85rem;text-align:center;padding:20px">Fermé ce jour</div>';
            return;
        }

        slots.forEach(slot => {
            const booked = isBookedFirebase(dateStr, slot);
            const busy   = isGcalBusy(selectedDay, slot);
            const taken  = booked || busy;

            const btn = document.createElement('div');
            btn.className = 'slot-btn' + (taken ? (booked ? ' booked' : ' gcal-busy') : '');

            const tagHtml = taken
                ? `<span class="slot-tag ${booked ? 'taken' : 'busy'}">${booked ? 'Réservé' : 'Occupé'}</span>`
                : '<span class="slot-tag free">Disponible</span>';

            btn.innerHTML = `<span class="slot-time">${slot.replace('–',' – ')}</span>${tagHtml}`;

            if (!taken) {
                btn.onclick = () => {
                    document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedSlot = slot;
                    document.getElementById('btn-reserve').disabled = false;
                };
            }
            list.appendChild(btn);
        });

        // Recalculer les points du calendrier
        renderCalendar();
    }

    function resetSlots() {
        selectedSlot = null;
        document.getElementById('sp-date').textContent = '';
        document.getElementById('sp-empty').style.display  = 'flex';
        document.getElementById('slots-list').style.display = 'none';
        document.getElementById('booking-form').style.display = 'none';
        document.getElementById('btn-reserve').disabled = true;
    }

    // ── Soumettre la réservation
    async function submitReservation() {
        const nom   = document.getElementById('bf-nom').value.trim();
        const tel   = document.getElementById('bf-tel').value.trim();
        const email = document.getElementById('bf-email').value.trim();
        const type  = document.getElementById('bf-type').value.trim();

        if (!nom || !tel || !email) {
            showErr('Veuillez remplir votre nom, téléphone et courriel.');
            return;
        }
        if (!selectedDay || !selectedSlot) {
            showErr('Veuillez sélectionner une date et un créneau.');
            return;
        }

        const btn = document.getElementById('btn-reserve');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Confirmation...';
        document.getElementById('err').classList.remove('show');

        const days_fr   = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
        const months_fr = ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];
        const dateLabel = `${days_fr[selectedDay.getDay()]} ${selectedDay.getDate()} ${months_fr[selectedDay.getMonth()]} ${selectedDay.getFullYear()}`;
        const dateStr   = toDateStr(selectedDay);

        const payload = {
            nom, telephone: tel, email,
            typeProbleme: type || 'Non spécifié',
            dateStr, dateLabel,
            slot:      selectedSlot,
            status:    'confirme',
            createdAt: new Date().toISOString(),
            source:    'calendar.html'
        };

        try {
            // Attendre Firebase
            let tries = 0;
            while (!window._fbSaveReservation && tries < 30) {
                await new Promise(r => setTimeout(r, 100)); tries++;
            }

            const key = await window._fbSaveReservation(payload);

            // Envoyer email (si EmailJS configuré)
            await sendConfirmationEmail({ ...payload, refId: key.slice(-8).toUpperCase() });

            // Succès
            document.getElementById('succ-summary').textContent =
                `${nom} — ${dateLabel} de ${selectedSlot.replace('–',' à ')}`;
            document.getElementById('succ-ref').textContent =
                'Référence : ' + key.slice(-8).toUpperCase();

            const overlay = document.getElementById('succ-overlay');
            overlay.classList.add('show');
            gsap.fromTo('.succ-box', {opacity:0,scale:.93}, {opacity:1,scale:1,duration:.55,ease:'back.out(1.4)'});

        } catch(e) {
            console.error(e);
            showErr('Erreur de connexion. Veuillez réessayer ou nous appeler.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-calendar-check"></i> Confirmer la réservation';
        }
    }

    function showErr(msg) {
        document.getElementById('err-msg').textContent = msg;
        document.getElementById('err').classList.add('show');
    }

    // Fermer overlay en cliquant dehors
    document.getElementById('succ-overlay').onclick = function(e) {
        if (e.target === this) this.classList.remove('show');
    };
</script>

</body>
</html>