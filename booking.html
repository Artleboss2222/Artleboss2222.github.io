<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demande de Service — Plomberie St-Mars Inc.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --bg:      #050505;
            --text:    #ffffff;
            --blue:    #0055ff;
            --gold:    #FFD700;
            --s1:      #111111;
            --s2:      #181818;
            --border:  rgba(255,255,255,0.08);
            --ease:    cubic-bezier(0.23,1,0.32,1);
        }
        *{margin:0;padding:0;box-sizing:border-box;outline:none}
        html{background:var(--bg);scroll-behavior:smooth}
        body{font-family:'Inter',sans-serif;color:var(--text);line-height:1.6;min-height:100vh;overflow-x:hidden}
        h1,h2,h3,h4,.logo{font-family:'Syne',sans-serif;text-transform:uppercase}

        /* NAV */
        .navbar{position:fixed;top:0;width:100%;z-index:1000;padding:1.2rem 0;background:rgba(5,5,5,0.85);backdrop-filter:blur(16px);border-bottom:1px solid var(--border)}
        .nav-c{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 5%}
        .logo{font-size:1.4rem;font-weight:800;letter-spacing:-1px;text-decoration:none;color:var(--text)}
        .nav-back{display:flex;align-items:center;gap:6px;text-decoration:none;color:rgba(255,255,255,0.5);font-size:0.85rem;font-weight:600;transition:color .3s}
        .nav-back:hover{color:var(--text)}
        .nav-phone{background:var(--blue);color:#fff;padding:.7rem 1.3rem;border-radius:4px;text-decoration:none;font-weight:600;font-size:.85rem}

        /* LAYOUT */
        .page{min-height:100vh;padding-top:100px;padding-bottom:80px;display:flex;justify-content:center}
        .wrap{width:100%;max-width:720px;padding:0 24px}

        /* HEADER */
        .bh{margin-bottom:48px;opacity:0;transform:translateY(30px)}
        .tag{display:inline-flex;align-items:center;gap:8px;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:2px;color:var(--blue);margin-bottom:16px}
        .tag::before{content:'';display:block;width:24px;height:1px;background:var(--blue)}
        .bh h1{font-size:clamp(2rem,5vw,3.5rem);line-height:1;margin-bottom:12px}
        .bh h1 span{color:var(--blue)}
        .bh p{color:rgba(255,255,255,.5);font-size:1rem}

        /* PROGRESS */
        .prog{display:flex;align-items:center;margin-bottom:40px;opacity:0;transform:translateY(20px)}
        .ps{display:flex;align-items:center;gap:10px;flex:1}
        .sc{width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:var(--s1);display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700;font-family:'Syne',sans-serif;color:rgba(255,255,255,.3);flex-shrink:0;transition:all .4s var(--ease)}
        .sc.active{border-color:var(--blue);background:var(--blue);color:#fff}
        .sc.done{border-color:rgba(0,85,255,.4);background:rgba(0,85,255,.15);color:var(--blue)}
        .sl{font-size:.72rem;text-transform:uppercase;letter-spacing:1px;font-weight:600;color:rgba(255,255,255,.3);transition:color .4s;white-space:nowrap}
        .ps.active .sl{color:rgba(255,255,255,.8)}
        .ps.done .sl{color:rgba(0,85,255,.7)}
        .line{flex:1;height:1px;background:var(--border);margin:0 12px;transition:background .4s}
        .line.done{background:rgba(0,85,255,.3)}

        /* CARD */
        .card{background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:48px;opacity:0;transform:translateY(24px)}
        .panel{display:none}
        .panel.active{display:block}
        .panel h2{font-size:1.5rem;margin-bottom:6px}
        .sdesc{color:rgba(255,255,255,.45);font-size:.9rem;margin-bottom:32px}

        /* FIELDS */
        .fg{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
        .fg.full{grid-template-columns:1fr}
        .f{display:flex;flex-direction:column;gap:8px}
        .f label{font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.45)}
        .f input,.f textarea,.f select{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;color:var(--text);font-family:'Inter',sans-serif;font-size:.95rem;transition:border-color .3s;width:100%}
        .f input::placeholder,.f textarea::placeholder{color:rgba(255,255,255,.2)}
        .f input:focus,.f textarea:focus{border-color:var(--blue)}
        .f textarea{resize:vertical;min-height:120px}

        /* URGENCE */
        .utoggle{display:flex;gap:12px;margin-bottom:24px}
        .ubtn{flex:1;padding:14px;border-radius:10px;border:1px solid var(--border);background:var(--s2);color:rgba(255,255,255,.45);font-family:'Inter',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .3s}
        .ubtn:hover{border-color:rgba(255,255,255,.2);color:rgba(255,255,255,.7)}
        .ubtn.u-urg{border-color:#f44;background:rgba(255,68,68,.1);color:#f88}
        .ubtn.u-nor{border-color:var(--blue);background:rgba(0,85,255,.1);color:#69f}

        /* SERVICE CARDS */
        .sgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
        .sc2{padding:20px;border-radius:12px;border:1px solid var(--border);background:var(--s2);cursor:pointer;display:flex;align-items:center;gap:14px;transition:all .3s}
        .sc2:hover{border-color:rgba(255,255,255,.2)}
        .sc2.sel{border-color:var(--blue);background:rgba(0,85,255,.08)}
        .ci{width:42px;height:42px;border-radius:10px;background:rgba(255,255,255,.05);display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:rgba(255,255,255,.4);transition:all .3s;flex-shrink:0}
        .sc2.sel .ci{background:rgba(0,85,255,.15);color:var(--blue)}
        .ct strong{display:block;font-size:.9rem;font-weight:600;color:rgba(255,255,255,.8);margin-bottom:2px}
        .ct span{font-size:.75rem;color:rgba(255,255,255,.35)}

        /* PHOTOS */
        .pdrop{border:1px dashed rgba(255,255,255,.15);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .3s;position:relative;margin-bottom:16px}
        .pdrop:hover,.pdrop.dov{border-color:var(--blue);background:rgba(0,85,255,.04)}
        .pdrop input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
        .pdrop .di{font-size:2rem;color:rgba(255,255,255,.15);margin-bottom:12px}
        .pdrop p{font-size:.85rem;color:rgba(255,255,255,.35)}
        .pdrop p strong{color:rgba(255,255,255,.6)}
        .ppreviews{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px}
        .pprev{width:72px;height:72px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}

        /* SLOTS */
        .dlabel{font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.45);margin-bottom:10px;display:block}
        .slots{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:24px}
        .slot{padding:12px 8px;border-radius:10px;border:1px solid var(--border);background:var(--s2);color:rgba(255,255,255,.5);font-size:.85rem;font-weight:600;text-align:center;cursor:pointer;transition:all .3s}
        .slot:hover{border-color:rgba(255,255,255,.2);color:rgba(255,255,255,.8)}
        .slot.sel{border-color:var(--blue);background:rgba(0,85,255,.12);color:#69f}

        /* SUMMARY */
        .sblock{background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:16px}
        .sblock h4{font-size:.72rem;text-transform:uppercase;letter-spacing:2px;color:rgba(255,255,255,.3);margin-bottom:14px}
        .srow{display:flex;justify-content:space-between;align-items:flex-start;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);gap:16px}
        .srow:last-child{border-bottom:none}
        .slbl{font-size:.82rem;color:rgba(255,255,255,.35);white-space:nowrap}
        .sval{font-size:.88rem;color:rgba(255,255,255,.85);text-align:right}
        .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:.75rem;font-weight:600}
        .badge.r{background:rgba(255,68,68,.15);color:#f88;border:1px solid rgba(255,68,68,.3)}
        .badge.b{background:rgba(0,85,255,.15);color:#69f;border:1px solid rgba(0,85,255,.3)}

        /* ERROR */
        .errbanner{background:rgba(255,68,68,.1);border:1px solid rgba(255,68,68,.3);color:#f88;border-radius:10px;padding:14px 18px;font-size:.88rem;margin-top:16px;display:none;align-items:center;gap:10px}
        .errbanner.show{display:flex}

        /* NAV BTNS */
        .fnav{display:flex;justify-content:space-between;align-items:center;margin-top:36px;padding-top:28px;border-top:1px solid var(--border)}
        .bback{background:transparent;border:1px solid var(--border);color:rgba(255,255,255,.45);padding:.85rem 1.6rem;border-radius:8px;cursor:pointer;font-family:'Inter',sans-serif;font-size:.85rem;font-weight:600;display:flex;align-items:center;gap:8px;transition:all .3s}
        .bback:hover{border-color:rgba(255,255,255,.2);color:var(--text)}
        .bnext{background:var(--blue);border:none;color:#fff;padding:.85rem 2rem;border-radius:8px;cursor:pointer;font-family:'Inter',sans-serif;font-size:.9rem;font-weight:700;display:flex;align-items:center;gap:10px;transition:all .3s;letter-spacing:.5px}
        .bnext:hover:not(:disabled){background:#0044dd;box-shadow:0 0 30px rgba(0,85,255,.35);transform:translateY(-1px)}
        .bnext:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .bnext.submit{background:linear-gradient(135deg,#0055ff,#0033cc)}

        /* SUCCESS */
        .succ{display:none;text-align:center;padding:24px 0}
        .succ.show{display:block}
        .sicon{width:80px;height:80px;border-radius:50%;background:rgba(0,85,255,.12);border:1px solid rgba(0,85,255,.3);display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--blue);margin:0 auto 28px}
        .succ h2{font-size:2rem;margin-bottom:12px}
        .succ h2 span{color:var(--blue)}
        .succ p{color:rgba(255,255,255,.5);max-width:420px;margin:0 auto 16px;font-size:.95rem}
        .refid{display:inline-block;font-family:'Syne',sans-serif;font-size:.7rem;letter-spacing:2px;color:rgba(255,255,255,.3);background:var(--s2);border:1px solid var(--border);border-radius:6px;padding:6px 14px;margin-bottom:28px}
        .sacts{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
        .bcall{background:var(--blue);color:#fff;padding:.85rem 1.8rem;border-radius:8px;text-decoration:none;font-weight:700;font-size:.9rem;display:inline-flex;align-items:center;gap:8px;transition:all .3s}
        .bcall:hover{background:#0044dd;box-shadow:0 0 30px rgba(0,85,255,.35)}
        .bhome{border:1px solid var(--border);color:rgba(255,255,255,.5);padding:.85rem 1.8rem;border-radius:8px;text-decoration:none;font-weight:600;font-size:.9rem;display:inline-flex;align-items:center;gap:8px;transition:all .3s}
        .bhome:hover{border-color:rgba(255,255,255,.2);color:var(--text)}

        @media(max-width:640px){
            .card{padding:28px 20px}
            .fg{grid-template-columns:1fr}
            .sgrid{grid-template-columns:1fr}
            .slots{grid-template-columns:repeat(2,1fr)}
            .sl{display:none}
            .line{margin:0 6px}
        }
    </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar">
    <div class="nav-c">
        <a href="index.html" class="logo">ST-MARS</a>
        <a href="index.html" class="nav-back"><i class="fa-solid fa-arrow-left"></i> Retour</a>
        <a href="tel:5149338411" class="nav-phone"><i class="fa-solid fa-phone"></i> (514) 933-8411</a>
    </div>
</nav>

<div class="page">
<div class="wrap">

    <!-- HEADER -->
    <div class="bh">
        <div class="tag">Demande de service</div>
        <h1>Décrivez votre <span>problème</span></h1>
        <p>Remplissez le formulaire en 4 étapes — nous vous recontactons sous 30 minutes.</p>
    </div>

    <!-- PROGRESS -->
    <div class="prog" id="prog">
        <div class="ps active" id="ps1"><div class="sc active" id="sc1">1</div><span class="sl">Coordonnées</span></div>
        <div class="line" id="ln1"></div>
        <div class="ps" id="ps2"><div class="sc" id="sc2">2</div><span class="sl">Problème</span></div>
        <div class="line" id="ln2"></div>
        <div class="ps" id="ps3"><div class="sc" id="sc3">3</div><span class="sl">Disponibilité</span></div>
        <div class="line" id="ln3"></div>
        <div class="ps" id="ps4"><div class="sc" id="sc4">4</div><span class="sl">Confirmation</span></div>
    </div>

    <!-- FORM CARD -->
    <div class="card" id="fcard">

        <!-- STEP 1 -->
        <div class="panel active" id="st1">
            <h2>Vos coordonnées</h2>
            <p class="sdesc">Pour qu'on puisse vous rejoindre rapidement.</p>
            <div class="fg">
                <div class="f"><label>Prénom *</label><input type="text" id="prenom" placeholder="Jean"></div>
                <div class="f"><label>Nom *</label><input type="text" id="nom" placeholder="Tremblay"></div>
            </div>
            <div class="fg">
                <div class="f"><label>Téléphone *</label><input type="tel" id="telephone" placeholder="(514) 000-0000"></div>
                <div class="f"><label>Courriel</label><input type="email" id="email" placeholder="jean@exemple.com"></div>
            </div>
            <div class="fg full">
                <div class="f"><label>Adresse *</label><input type="text" id="adresse" placeholder="1234 Rue Exemple, Montréal, QC"></div>
            </div>
            <div class="fg">
                <div class="f"><label>Appartement</label><input type="text" id="appt" placeholder="App. 4B"></div>
                <div class="f"><label>Code postal</label><input type="text" id="cp" placeholder="H0H 0H0"></div>
            </div>
            <div class="fnav">
                <div></div>
                <button class="bnext" onclick="nextStep(1)">Continuer <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- STEP 2 -->
        <div class="panel" id="st2">
            <h2>Le problème</h2>
            <p class="sdesc">Dites-nous ce qui se passe pour qu'on arrive préparé.</p>

            <span class="dlabel">Niveau d'urgence</span>
            <div class="utoggle">
                <button class="ubtn" id="bu" onclick="setUrg('urgence')"><i class="fa-solid fa-triangle-exclamation"></i> Urgence — maintenant</button>
                <button class="ubtn" id="bn" onclick="setUrg('normal')"><i class="fa-solid fa-calendar-check"></i> Planifié — sans urgence</button>
            </div>

            <span class="dlabel">Type de service</span>
            <div class="sgrid">
                <!-- FIX: Remplacé &quot; par des apostrophes simples dans tous les onclick -->
                <div class="sc2" onclick="setSvc(this, 'Fuite d\'eau')"><div class="ci"><i class="fa-solid fa-droplet"></i></div><div class="ct"><strong>Fuite d'eau</strong><span>Tuyaux, robinets, joints</span></div></div>
                <div class="sc2" onclick="setSvc(this, 'Refoulement')"><div class="ci"><i class="fa-solid fa-arrows-up-down"></i></div><div class="ct"><strong>Refoulement</strong><span>Égouts, drain, odeurs</span></div></div>
                <div class="sc2" onclick="setSvc(this, 'Gaz naturel')"><div class="ci"><i class="fa-solid fa-fire-flame-curved"></i></div><div class="ct"><strong>Gaz naturel</strong><span>Installation, inspection</span></div></div>
                <div class="sc2" onclick="setSvc(this, 'Rénovation')"><div class="ci"><i class="fa-solid fa-wrench"></i></div><div class="ct"><strong>Rénovation</strong><span>Salle de bain, cuisine</span></div></div>
                <div class="sc2" onclick="setSvc(this, 'Chauffe-eau')"><div class="ci"><i class="fa-solid fa-temperature-high"></i></div><div class="ct"><strong>Chauffe-eau</strong><span>Remplacement, réparation</span></div></div>
                <div class="sc2" onclick="setSvc(this, 'Autre')"><div class="ci"><i class="fa-solid fa-circle-question"></i></div><div class="ct"><strong>Autre</strong><span>Je décris ci-dessous</span></div></div>
            </div>

            <div class="fg full" style="margin-top:16px">
                <div class="f"><label>Description *</label><textarea id="desc" placeholder="Décrivez ce que vous observez : depuis quand, à quel endroit, symptômes visibles..."></textarea></div>
            </div>

            <span class="dlabel">Photos (optionnel — max 5)</span>
            <div class="ppreviews" id="pprev"></div>
            <div class="pdrop" id="pdrop">
                <input type="file" accept="image/*" multiple id="finput" onchange="handlePhotos(this)">
                <div class="di"><i class="fa-solid fa-camera"></i></div>
                <p><strong>Cliquez ou glissez vos photos ici</strong></p>
                <p>JPG, PNG, HEIC</p>
            </div>

            <div class="fnav">
                <button class="bback" onclick="prevStep(2)"><i class="fa-solid fa-arrow-left"></i> Retour</button>
                <button class="bnext" onclick="nextStep(2)">Continuer <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- STEP 3 -->
        <div class="panel" id="st3">
            <h2>Vos disponibilités</h2>
            <p class="sdesc">Choisissez quand vous pouvez nous recevoir.</p>
            <div class="fg full">
                <div class="f"><label>Date préférée *</label><input type="date" id="datepref"></div>
            </div>
            <span class="dlabel" style="margin-top:8px">Plage horaire préférée</span>
            <div class="slots">
                <div class="slot" onclick="setSlot(this)">7h – 9h</div>
                <div class="slot" onclick="setSlot(this)">9h – 11h</div>
                <div class="slot" onclick="setSlot(this)">11h – 13h</div>
                <div class="slot" onclick="setSlot(this)">13h – 15h</div>
                <div class="slot" onclick="setSlot(this)">15h – 17h</div>
                <div class="slot" onclick="setSlot(this)">Soir / Flexible</div>
            </div>
            <div class="fg full">
                <div class="f"><label>Notes d'accès (optionnel)</label><input type="text" id="acces" placeholder="Code de porte, interphone, chien dans la cour..."></div>
            </div>
            <div class="fnav">
                <button class="bback" onclick="prevStep(3)"><i class="fa-solid fa-arrow-left"></i> Retour</button>
                <button class="bnext" onclick="nextStep(3)">Vérifier <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- STEP 4 — RÉSUMÉ -->
        <div class="panel" id="st4">
            <h2>Confirmation</h2>
            <p class="sdesc">Vérifiez vos informations avant d'envoyer.</p>

            <div class="sblock">
                <h4>Coordonnées</h4>
                <div class="srow"><span class="slbl">Nom</span><span class="sval" id="r-nom">—</span></div>
                <div class="srow"><span class="slbl">Téléphone</span><span class="sval" id="r-tel">—</span></div>
                <div class="srow"><span class="slbl">Courriel</span><span class="sval" id="r-email">—</span></div>
                <div class="srow"><span class="slbl">Adresse</span><span class="sval" id="r-adresse">—</span></div>
            </div>
            <div class="sblock">
                <h4>Problème</h4>
                <div class="srow"><span class="slbl">Urgence</span><span class="sval" id="r-urg">—</span></div>
                <div class="srow"><span class="slbl">Type</span><span class="sval" id="r-type">—</span></div>
                <div class="srow"><span class="slbl">Description</span><span class="sval" id="r-desc" style="max-width:320px">—</span></div>
            </div>
            <div class="sblock">
                <h4>Disponibilité</h4>
                <div class="srow"><span class="slbl">Date</span><span class="sval" id="r-date">—</span></div>
                <div class="srow"><span class="slbl">Plage</span><span class="sval" id="r-slot">—</span></div>
                <div class="srow"><span class="slbl">Accès</span><span class="sval" id="r-acces">—</span></div>
            </div>

            <div class="errbanner" id="errbanner">
                <i class="fa-solid fa-circle-exclamation"></i>
                <span id="errmsg">Erreur de connexion. Veuillez réessayer ou nous appeler directement.</span>
            </div>

            <div class="fnav">
                <button class="bback" onclick="prevStep(4)"><i class="fa-solid fa-arrow-left"></i> Modifier</button>
                <button class="bnext submit" id="sbtn" onclick="submitForm()">
                    <i class="fa-solid fa-paper-plane"></i> Envoyer la demande
                </button>
            </div>
        </div>

        <!-- SUCCESS -->
        <div class="succ" id="succ">
            <div class="sicon"><i class="fa-solid fa-check"></i></div>
            <h2>Demande <span>envoyée</span> !</h2>
            <p>Nous avons bien reçu votre demande et vous contacterons dans les 30 prochaines minutes. Pour une urgence immédiate, appelez-nous.</p>
            <div class="refid" id="refid">Référence : —</div>
            <div class="sacts">
                <a href="tel:5149338411" class="bcall"><i class="fa-solid fa-phone"></i> (514) 933-8411</a>
                <a href="index.html" class="bhome"><i class="fa-solid fa-house"></i> Retour au site</a>
            </div>
        </div>

    </div><!-- /card -->
</div>
</div>

<!-- ═══════════════════════════════════
     FIREBASE REALTIME DATABASE
════════════════════════════════════ -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
        apiKey:            "AIzaSyAOvVeABSSBiZ-MKKsYUphIh0YqTa5cED8",
        authDomain:        "plomberie-saint-mars.firebaseapp.com",
        databaseURL:       "https://plomberie-saint-mars-default-rtdb.firebaseio.com",
        projectId:         "plomberie-saint-mars",
        storageBucket:     "plomberie-saint-mars.firebasestorage.app",
        messagingSenderId: "858495795021",
        appId:             "1:858495795021:web:e3c1c6387e07d30ab34104",
        measurementId:     "G-MR8W8BBLLK"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    window._fbPush = async (data) => {
        const r = await push(ref(db, "demandes"), data);
        return r.key;
    };
</script>

<script>
    // ── État
    let urgVal  = '';
    let svcVal  = '';
    let slotVal = '';
    let photos  = [];

    // ── Entrée animée
    window.addEventListener('load', () => {
        gsap.to('.bh',    { opacity:1, y:0, duration:.9, ease:'power3.out', delay:.1 });
        gsap.to('#prog',  { opacity:1, y:0, duration:.8, ease:'power3.out', delay:.25 });
        gsap.to('#fcard', { opacity:1, y:0, duration:.8, ease:'power3.out', delay:.4 });
    });

    // ── Urgence
    function setUrg(v) {
        urgVal = v;
        document.getElementById('bu').className = 'ubtn' + (v==='urgence' ? ' u-urg' : '');
        document.getElementById('bn').className = 'ubtn' + (v==='normal'  ? ' u-nor' : '');
    }

    // ── Service
    function setSvc(el, v) {
        document.querySelectorAll('.sc2').forEach(c => c.classList.remove('sel'));
        el.classList.add('sel');
        svcVal = v;
    }

    // ── Slot
    function setSlot(el) {
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('sel'));
        el.classList.add('sel');
        slotVal = el.textContent.trim();
    }

    // ── Photos
    function handlePhotos(input) {
        const prev = document.getElementById('pprev');
        prev.innerHTML = '';
        photos = [];
        Array.from(input.files).slice(0,5).forEach(file => {
            const r = new FileReader();
            r.onload = e => {
                photos.push(e.target.result);
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'pprev';
                prev.appendChild(img);
            };
            r.readAsDataURL(file);
        });
        if (input.files.length) document.getElementById('pdrop').style.display = 'none';
    }

    const pdrop = document.getElementById('pdrop');
    pdrop.addEventListener('dragover', e => { e.preventDefault(); pdrop.classList.add('dov'); });
    pdrop.addEventListener('dragleave', () => pdrop.classList.remove('dov'));
    pdrop.addEventListener('drop', e => {
        e.preventDefault(); pdrop.classList.remove('dov');
        document.getElementById('finput').files = e.dataTransfer.files;
        handlePhotos(document.getElementById('finput'));
    });

    // ── Navigation
    function goTo(from, to) {
        document.getElementById('st'+from).classList.remove('active');
        const c = document.getElementById('sc'+from);
        c.innerHTML = '<i class="fa-solid fa-check" style="font-size:.7rem"></i>';
        c.className = 'sc done';
        document.getElementById('ps'+from).className = 'ps done';
        if (document.getElementById('ln'+from)) document.getElementById('ln'+from).classList.add('done');
        document.getElementById('sc'+to).className = 'sc active';
        document.getElementById('ps'+to).className = 'ps active';
        if (to === 4) fillSummary();
        const panel = document.getElementById('st'+to);
        panel.classList.add('active');
        gsap.fromTo(panel, {opacity:0,x:40}, {opacity:1,x:0,duration:.5,ease:'power3.out'});
    }

    function goBack(from, to) {
        document.getElementById('st'+from).classList.remove('active');
        const c = document.getElementById('sc'+from);
        c.innerHTML = from;
        c.className = 'sc';
        document.getElementById('ps'+from).className = 'ps';
        if (document.getElementById('ln'+to)) document.getElementById('ln'+to).classList.remove('done');
        const cp = document.getElementById('sc'+to);
        cp.innerHTML = to;
        cp.className = 'sc active';
        document.getElementById('ps'+to).className = 'ps active';
        const panel = document.getElementById('st'+to);
        panel.classList.add('active');
        gsap.fromTo(panel, {opacity:0,x:-40}, {opacity:1,x:0,duration:.5,ease:'power3.out'});
    }

    function nextStep(n) {
        if (n===1) {
            if (!v('prenom') || !v('telephone') || !v('adresse')) { shake(); return; }
        }
        if (n===2) {
            if (!v('desc')) { shake(); return; }
        }
        if (n===3) {
            if (!v('datepref')) { shake(); return; }
        }
        goTo(n, n+1);
    }

    function prevStep(n) { goBack(n, n-1); }

    const v = id => document.getElementById(id).value.trim();

    function shake() {
        gsap.fromTo('#fcard', {x:0}, {x:10, duration:.07, yoyo:true, repeat:5, ease:'none', onComplete:()=>gsap.set('#fcard',{x:0})});
    }

    // ── Résumé
    function fillSummary() {
        const adresseFull = [v('adresse'), v('appt'), v('cp')].filter(Boolean).join(', ');
        document.getElementById('r-nom').textContent    = [v('prenom'), v('nom')].filter(Boolean).join(' ') || '—';
        document.getElementById('r-tel').textContent    = v('telephone') || '—';
        document.getElementById('r-email').textContent  = v('email') || '—';
        document.getElementById('r-adresse').textContent = adresseFull || '—';
        document.getElementById('r-type').textContent   = svcVal || '—';
        document.getElementById('r-desc').textContent   = v('desc') || '—';
        document.getElementById('r-slot').textContent   = slotVal || '—';
        document.getElementById('r-acces').textContent  = v('acces') || '—';

        const ru = document.getElementById('r-urg');
        if (urgVal==='urgence') ru.innerHTML = '<span class="badge r"><i class="fa-solid fa-triangle-exclamation"></i> Urgence</span>';
        else if (urgVal==='normal') ru.innerHTML = '<span class="badge b"><i class="fa-solid fa-calendar-check"></i> Planifié</span>';
        else ru.textContent = '—';

        const dp = v('datepref');
        if (dp) {
            const d = new Date(dp+'T12:00:00');
            let fmt = d.toLocaleDateString('fr-CA', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
            document.getElementById('r-date').textContent = fmt.charAt(0).toUpperCase() + fmt.slice(1);
        } else {
            document.getElementById('r-date').textContent = '—';
        }
    }

    // ── Envoi Firebase
    async function submitForm() {
        const btn = document.getElementById('sbtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Envoi en cours...';
        document.getElementById('errbanner').classList.remove('show');

        const adresseFull = [v('adresse'), v('appt'), v('cp')].filter(Boolean).join(', ');
        const dp = v('datepref');
        let dateFmt = dp;
        if (dp) {
            const d = new Date(dp+'T12:00:00');
            dateFmt = d.toLocaleDateString('fr-CA', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
        }

        const payload = {
            prenom:    v('prenom'),
            nom:       v('nom'),
            telephone: v('telephone'),
            email:     v('email'),
            adresse:   adresseFull,
            urgence:      urgVal || 'non-specifie',
            typeService:  svcVal || 'non-specifie',
            description:  v('desc'),
            nbPhotos:     photos.length,
            datePreferee: dateFmt,
            plageHoraire: slotVal || 'non-specifie',
            notesAcces:   v('acces') || '',
            status:       'nouveau',
            createdAt:    new Date().toISOString(),
            source:       'booking.html'
        };

        try {
            let tries = 0;
            while (!window._fbPush && tries < 30) {
                await new Promise(r => setTimeout(r, 100));
                tries++;
            }
            if (!window._fbPush) throw new Error('Firebase non chargé');

            const key = await window._fbPush(payload);

            document.getElementById('st4').classList.remove('active');
            document.getElementById('prog').style.display = 'none';
            const succ = document.getElementById('succ');
            succ.classList.add('show');
            document.getElementById('refid').textContent = 'Référence : ' + key.slice(-8).toUpperCase();
            gsap.fromTo(succ, {opacity:0,scale:.95}, {opacity:1,scale:1,duration:.6,ease:'back.out(1.3)'});

        } catch(err) {
            console.error(err);
            document.getElementById('errmsg').textContent = 'Erreur : ' + (err.message || 'connexion impossible. Veuillez nous appeler.');
            document.getElementById('errbanner').classList.add('show');
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Réessayer';
        }
    }
</script>

</body>
</html>